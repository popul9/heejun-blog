---
import { getLangFromUrl, getLocalizedPathname } from "../i18n/utils";

const lang = getLangFromUrl(Astro.url);
const path = Astro.url.pathname;

const languages: { code: "ko" | "en"; label: string }[] = [
    { code: "ko", label: "한국어" },
    { code: "en", label: "English" },
];

const currentLangLabel =
    languages.find((l) => l.code === lang)?.label || "Language";
---

<div class="floating-lang-toggle" id="liquid-glass-toggle">
    <svg
        class="lg-filter-svg"
        xmlns="http://www.w3.org/2000/svg"
        aria-hidden="true"
    >
        <defs>
            <filter
                id="lg-filter"
                x="0"
                y="0"
                width="100%"
                height="100%"
                color-interpolation-filters="sRGB"
                filterUnits="userSpaceOnUse"
            >
                <feImage
                    id="lg-disp-img"
                    result="DISPLACEMENT_MAP"
                    preserveAspectRatio="none"></feImage>
                <feDisplacementMap
                    in="SourceGraphic"
                    in2="DISPLACEMENT_MAP"
                    scale="28"
                    xChannelSelector="R"
                    yChannelSelector="G"
                    result="refracted"></feDisplacementMap>
                <feImage
                    id="lg-spec-img"
                    result="spec_map"
                    preserveAspectRatio="none"></feImage>
                <feComposite
                    in="spec_map"
                    in2="refracted"
                    operator="in"
                    result="spec_clipped"></feComposite>
                <feBlend in="refracted" in2="spec_clipped" mode="screen"
                ></feBlend>
            </filter>
        </defs>
    </svg>

    <div class="lg-content-wrapper">
        <button
            class="lang-toggle-btn"
            aria-expanded="false"
            aria-label="Toggle language menu"
            id="lang-toggle-btn"
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                class="globe-icon"
            >
                <circle
                    cx="12"
                    cy="12"
                    r="10"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"></circle>
                <path
                    d="M2 12h20"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
                <path
                    d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="1.8"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg>
            <span class="toggle-label">{currentLangLabel}</span>
            <svg class="chevron-icon" viewBox="0 0 24 24">
                <path
                    d="M6 9l6 6 6-6"
                    fill="none"
                    stroke="#ffffff"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"></path>
            </svg>
        </button>

        <div class="lang-menu" id="lang-menu">
            {
                languages.map((l) => (
                    <a
                        href={getLocalizedPathname(path, l.code)}
                        class={`lang-option ${lang === l.code ? "active" : ""}`}
                    >
                        {l.label}
                    </a>
                ))
            }
        </div>
    </div>

    <span class="lg-border lg-border--screen"></span>
    <span class="lg-border lg-border--overlay"></span>
</div>

<style is:global>
    .floating-lang-toggle {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        z-index: 9999;
        display: flex !important;
        flex-direction: column;
        border-radius: 24px;

        text-decoration: none !important;
        cursor: pointer;
        user-select: none;
        -webkit-tap-highlight-color: transparent;
        box-sizing: border-box;

        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15), 0 1px 4px rgba(0, 0, 0, 0.1),
            inset 0 1px 0 rgba(255, 255, 255, 0.9);

        transition: transform 0.2s ease, box-shadow 0.2s ease;

        /* ── Safari / Firefox 폴백: 강한 frosted glass ──
           backdrop-filter: url() 미지원 브라우저에서 사용
           blur 강도↑ + saturate + contrast로 진짜 유리 느낌 */
        border: 1px solid rgba(255, 255, 255, 0.75);
        background: rgba(210, 215, 225, 0.72) !important;
        backdrop-filter: blur(10px) saturate(1.4) brightness(1.12)
            contrast(1.08);
        -webkit-backdrop-filter: blur(10px) saturate(1.4) brightness(1.12)
            contrast(1.08);
    }

    @supports (backdrop-filter: url(#x)) {
        .floating-lang-toggle:not(.safari-fallback) {
            background: rgba(255, 255, 255, 0.05) !important;
            backdrop-filter: url(#lg-filter) blur(0.5px);
            -webkit-backdrop-filter: url(#lg-filter) blur(0.5px);
        }
    }
    .safari-fallback {
        background: rgba(210, 215, 225, 0.3) !important;
        backdrop-filter: blur(10px) saturate(1.4) brightness(1.12)
            contrast(1.08) !important;
        -webkit-backdrop-filter: blur(10px) saturate(1.4) brightness(1.12)
            contrast(1.08) !important;
    }

    .floating-lang-toggle:hover {
        transform: translateY(-2px) scale(1.03);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.32),
            0 4px 12px rgba(0, 0, 0, 0.18),
            inset 0 1px 0 rgba(255, 255, 255, 0.42);
    }

    .floating-lang-toggle:active {
        /* Removed to prevent jumpy scaling when interacting with inner menu */
    }

    .floating-lang-toggle::before {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        z-index: 1;
        background: linear-gradient(
                175deg,
                rgba(255, 255, 255, 0.55) 0%,
                rgba(255, 255, 255, 0.18) 30%,
                rgba(255, 255, 255, 0.04) 60%,
                rgba(255, 255, 255, 0) 100%
            ),
            radial-gradient(
                ellipse 60% 50% at 20% 10%,
                rgba(255, 255, 255, 0.3) 0%,
                rgba(255, 255, 255, 0) 100%
            );
    }

    .floating-lang-toggle::after {
        content: "";
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        z-index: 1;
        opacity: 0.45;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='200'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.72' numOctaves='4' stitchTiles='stitch'/%3E%3CfeColorMatrix type='saturate' values='0'/%3E%3C/filter%3E%3Crect width='200' height='200' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
        background-size: 160px 160px;
        mix-blend-mode: overlay;
    }
    @supports (backdrop-filter: url(#x)) {
        .floating-lang-toggle::before,
        .floating-lang-toggle::after {
            opacity: 0;
        }
    }

    .floating-lang-toggle .lg-filter-svg {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: visible;
        opacity: 0;
    }

    .floating-lang-toggle .lg-content-wrapper {
        position: relative;
        z-index: 2;
        display: flex;
        flex-direction: column;
        padding: 0.55rem 0.9rem;
    }

    .lang-toggle-btn {
        display: flex;
        align-items: center;
        gap: 0.4rem;
        background: none;
        border: none;
        padding: 0;
        cursor: pointer;
        color: inherit;
        font-family: inherit;
        outline: none;
    }

    .chevron-icon {
        width: 16px;
        height: 16px;
        transition: transform 0.3s ease;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
    }

    .floating-lang-toggle.is-expanded .chevron-icon {
        transform: rotate(180deg);
    }

    .lang-menu {
        max-height: 0;
        opacity: 0;
        overflow: hidden;
        transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1),
            opacity 0.3s ease, margin 0.3s ease, padding 0.3s ease;
        display: flex;
        flex-direction: column;
        gap: 0.6rem;
        margin-top: 0;
        padding-top: 0;
        border-top: 1px solid transparent;
    }

    .floating-lang-toggle.is-expanded .lang-menu {
        max-height: 150px;
        opacity: 1;
        margin-top: 0.6rem;
        padding-top: 0.6rem;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
    }

    .lang-option {
        color: #ffffff;
        text-decoration: none;
        font-size: 0.85rem;
        font-weight: 500;
        letter-spacing: 0.02em;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
        padding-left: 1.8rem;
        transition: color 0.2s ease, transform 0.2s ease, text-shadow 0.2s ease;
        display: block;
        opacity: 0.8;
    }

    .lang-option:hover {
        opacity: 1;
        transform: translateX(4px);
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.6);
    }

    .lang-option.active {
        opacity: 1;
        font-weight: 700;
    }

    .floating-lang-toggle .lg-border {
        position: absolute;
        inset: 0;
        border-radius: inherit;
        pointer-events: none;
        z-index: 3;
        padding: 1.5px;
        -webkit-mask: linear-gradient(#000 0 0) content-box,
            linear-gradient(#000 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        box-shadow: 0 0 0 0.5px rgba(255, 255, 255, 0.5) inset,
            0 1px 3px rgba(255, 255, 255, 0.25) inset,
            0 1px 4px rgba(0, 0, 0, 0.35);
        background: linear-gradient(
            135deg,
            rgba(255, 255, 255, 0) 0%,
            rgba(255, 255, 255, 0.28) 40%,
            rgba(255, 255, 255, 0.55) 68%,
            rgba(255, 255, 255, 0) 100%
        );
    }

    .floating-lang-toggle .lg-border--screen {
        mix-blend-mode: screen;
        opacity: 0.2;
    }

    .floating-lang-toggle .lg-border--overlay {
        mix-blend-mode: overlay;
    }

    .floating-lang-toggle .globe-icon {
        width: 20px;
        height: 20px;
        flex-shrink: 0;
        display: block;
        filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.5));
    }

    .floating-lang-toggle .toggle-label {
        line-height: 1;
        color: #ffffff;
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.02em;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* ─── 모바일 ──────────────────────────────────────────────────── */
    @media (max-width: 720px) {
        .floating-lang-toggle {
            bottom: 1.25rem;
            right: 1.25rem;
        }

        .floating-lang-toggle .lg-content-wrapper {
            padding: 0.5rem 0.75rem;
        }

        .floating-lang-toggle .globe-icon {
            width: 17px;
            height: 17px;
        }

        .floating-lang-toggle .toggle-label {
            font-size: 0.8rem;
        }
    }
</style>

<script>
    const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
    if (isSafari) {
        document
            .getElementById("liquid-glass-toggle")
            ?.classList.add("safari-fallback");
    }

    function smoothStep(a: number, b: number, t: number): number {
        t = Math.max(0, Math.min(1, (t - a) / (b - a)));
        return t * t * (3 - 2 * t);
    }

    function vecLen(x: number, y: number): number {
        return Math.sqrt(x * x + y * y);
    }

    function roundedRectSDF(
        x: number,
        y: number,
        halfW: number,
        halfH: number,
        radius: number
    ): number {
        const qx = Math.abs(x) - halfW + radius;
        const qy = Math.abs(y) - halfH + radius;
        return (
            Math.min(Math.max(qx, qy), 0) +
            vecLen(Math.max(qx, 0), Math.max(qy, 0)) -
            radius
        );
    }

    function liquidGlassFragment(
        uvx: number,
        uvy: number
    ): { x: number; y: number } {
        const ix = uvx - 0.5;
        const iy = uvy - 0.5;
        const dist = roundedRectSDF(ix, iy, 0.3, 0.15, 0.55);
        const displacement = smoothStep(0.75, 0, dist - 0.12);
        const scaled = smoothStep(0, 1, displacement);
        return {
            x: ix * scaled + 0.5,
            y: iy * scaled + 0.5,
        };
    }

    function buildDisplacementMap(w: number, h: number): string {
        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d")!;
        const imageData = ctx.createImageData(w, h);
        const data = imageData.data;

        let maxScale = 1e-6;
        const rawValues: number[] = [];

        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const pos = liquidGlassFragment(x / w, y / h);
                const dx = pos.x * w - x;
                const dy = pos.y * h - y;
                maxScale = Math.max(maxScale, Math.abs(dx), Math.abs(dy));
                rawValues.push(dx, dy);
            }
        }

        maxScale = Math.max(maxScale, 1);

        let idx = 0;
        for (let y = 0; y < h; y++) {
            for (let x = 0; x < w; x++) {
                const dx = rawValues[idx++];
                const dy = rawValues[idx++];

                const edgeDist = Math.min(x, y, w - x - 1, h - y - 1);
                const fade = Math.min(1, edgeDist / 2);

                const r = (dx * fade) / maxScale + 0.5;
                const g = (dy * fade) / maxScale + 0.5;

                const pi = (y * w + x) * 4;
                data[pi] = Math.max(0, Math.min(255, r * 255)); // R: X displacement
                data[pi + 1] = Math.max(0, Math.min(255, g * 255)); // G: Y displacement
                data[pi + 2] = 128; // B: neutral
                data[pi + 3] = 255;
            }
        }

        ctx.putImageData(imageData, 0, 0);
        return canvas.toDataURL();
    }

    // ─── Specular highlight map ───────────────────────────────────────────────
    function buildSpecularMap(w: number, h: number): string {
        const canvas = document.createElement("canvas");
        canvas.width = w;
        canvas.height = h;
        const ctx = canvas.getContext("2d")!;
        const ry = h / 2;

        ctx.clearRect(0, 0, w, h);
        ctx.save();

        ctx.beginPath();
        ctx.roundRect(0, 0, w, h, ry);
        ctx.clip();

        const g1 = ctx.createRadialGradient(
            w * 0.22,
            h * 0.08,
            0,
            w * 0.35,
            h * 0.42,
            w * 0.48
        );
        g1.addColorStop(0, "rgba(255,255,255,0.60)");
        g1.addColorStop(0.22, "rgba(255,255,255,0.22)");
        g1.addColorStop(0.55, "rgba(255,255,255,0.04)");
        g1.addColorStop(1, "rgba(255,255,255,0.00)");
        ctx.fillStyle = g1;
        ctx.fillRect(0, 0, w, h);

        const g2 = ctx.createRadialGradient(
            w * 0.9,
            h * 0.22,
            0,
            w * 0.84,
            h * 0.5,
            h * 0.65
        );
        g2.addColorStop(0, "rgba(255,255,255,0.32)");
        g2.addColorStop(0.5, "rgba(255,255,255,0.06)");
        g2.addColorStop(1, "rgba(255,255,255,0.00)");
        ctx.fillStyle = g2;
        ctx.fillRect(0, 0, w, h);

        const g3 = ctx.createLinearGradient(0, 0, 0, h * 0.22);
        g3.addColorStop(0, "rgba(255,255,255,0.50)");
        g3.addColorStop(1, "rgba(255,255,255,0.00)");
        ctx.fillStyle = g3;
        ctx.fillRect(0, 0, w, h * 0.22);

        ctx.restore();
        return canvas.toDataURL();
    }

    // ─── Init ─────────────────────────────────────────────────────────────────
    let cachedW = 0;
    let cachedH = 0;

    function applyLiquidGlass() {
        const el = document.getElementById("liquid-glass-toggle");
        if (!el) return;

        const rect = el.getBoundingClientRect();
        const w = Math.round(rect.width);
        const h = Math.round(rect.height);
        if (!w || !h) return;

        if (w === cachedW && h === cachedH) return;
        cachedW = w;
        cachedH = h;

        const dispImg = el.querySelector<SVGImageElement>("#lg-disp-img");
        const specImg = el.querySelector<SVGImageElement>("#lg-spec-img");
        const filter = el.querySelector<SVGFilterElement>("#lg-filter");
        if (!dispImg || !specImg || !filter) return;

        filter.setAttribute("width", String(w));
        filter.setAttribute("height", String(h));

        for (const img of [dispImg, specImg]) {
            img.setAttribute("x", "0");
            img.setAttribute("y", "0");
            img.setAttribute("width", String(w));
            img.setAttribute("height", String(h));
        }

        dispImg.setAttribute("href", buildDisplacementMap(w, h));
        specImg.setAttribute("href", buildSpecularMap(w, h));
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", () =>
            requestAnimationFrame(applyLiquidGlass)
        );
    } else {
        requestAnimationFrame(applyLiquidGlass);
    }

    const container = document.getElementById("liquid-glass-toggle");
    const btn = document.getElementById("lang-toggle-btn");

    if (btn && container) {
        btn.addEventListener("click", (e) => {
            e.stopPropagation();
            container.classList.toggle("is-expanded");
            btn.setAttribute(
                "aria-expanded",
                String(container.classList.contains("is-expanded"))
            );
        });

        document.addEventListener("click", (e) => {
            if (
                container.classList.contains("is-expanded") &&
                !container.contains(e.target as Node)
            ) {
                container.classList.remove("is-expanded");
                btn.setAttribute("aria-expanded", "false");
            }
        });
    }

    const ResizeObserver = (window as any).ResizeObserver;
    if (ResizeObserver && container) {
        const ro = new ResizeObserver(() => {
            requestAnimationFrame(applyLiquidGlass);
        });
        ro.observe(container);
    } else {
        window.addEventListener(
            "resize",
            () => requestAnimationFrame(applyLiquidGlass),
            { passive: true }
        );
    }
</script>
